{
  "entities": {
    "Company": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Company",
      "type": "object",
      "description": "Represents a company served by the accounting firm.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Company entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the company."
        },
        "cnpj": {
          "type": "string",
          "description": "CNPJ of the company."
        },
        "cnae": {
          "type": "string",
          "description": "National Classification of Economic Activities (CNAE) code of the company."
        },
        "address": {
          "type": "string",
          "description": "Full address of the company."
        },
        "taxRegime": {
          "type": "string",
          "description": "Tax regime of the company (e.g., Simples Nacional, Lucro Presumido)."
        },
        "assessmentRegime": {
          "type": "string",
          "description": "Assessment regime of the company."
        },
        "registrationStatus": {
          "type": "string",
          "description": "Registration status of the company (e.g., Apto, Inapto, Baixado)."
        },
        "startDate": {
          "type": "string",
          "description": "Date when the company started its activities.",
          "format": "date-time"
        },
        "mainContactId": {
          "type": "string",
          "description": "Reference to User. Main contact person within the company. (Relationship: User 1:N Company)"
        },
        "certificateA1Validity": {
          "type": "string",
          "description": "Expiration date of the A1 digital certificate.",
          "format": "date"
        },
        "certificateA1Url": {
          "type": "string",
          "format": "uri",
          "description": "URL of the A1 certificate file in Firebase Storage."
        }
      },
      "required": [
        "id",
        "name",
        "cnpj",
        "taxRegime",
        "registrationStatus",
        "startDate"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the system, either internal or a client.",
      "properties": {
        "uid": {
          "type": "string",
          "description": "Unique identifier for the User entity, matches Firebase Auth UID."
        },
        "displayName": {
          "type": "string",
          "description": "Name of the user."
        },
        "email": {
          "type": "string",
          "description": "Email address of the user.",
          "format": "email"
        },
        "roleId": {
          "type": "string",
          "description": "Reference to the Role entity that defines the user's permissions."
        },
        "photoURL": {
          "type": "string",
          "format": "uri",
          "description": "URL of the user's profile picture."
        }
      },
      "required": [
        "uid",
        "displayName",
        "email",
        "roleId"
      ]
    },
    "Role": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Role",
      "type": "object",
      "description": "Defines a set of permissions for a user role.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Role."
        },
        "name": {
          "type": "string",
          "description": "Name of the role (e.g., 'Administrador', 'Contador')."
        },
        "permissions": {
          "type": "object",
          "description": "A map of granular permissions.",
          "properties": {
            "dashboard": { "type": "object", "properties": { "view": { "type": "boolean" } } },
            "companies": { "type": "object", "properties": { "view": { "type": "boolean" }, "create": { "type": "boolean" }, "edit": { "type": "boolean" }, "delete": { "type": "boolean" } } },
            "partners": { "type": "object", "properties": { "view": { "type": "boolean" }, "create": { "type": "boolean" }, "edit": { "type": "boolean" }, "delete": { "type": "boolean" } } },
            "obligations": { "type": "object", "properties": { "view": { "type": "boolean" }, "create": { "type": "boolean" }, "edit": { "type": "boolean" }, "delete": { "type": "boolean" } } },
            "processes": { "type": "object", "properties": { "view": { "type": "boolean" }, "create": { "type": "boolean" }, "edit": { "type": "boolean" }, "delete": { "type": "boolean" } } },
            "documents": { "type": "object", "properties": { "view": { "type": "boolean" }, "upload": { "type": "boolean" }, "download": { "type": "boolean" }, "delete": { "type": "boolean" } } },
            "users": { "type": "object", "properties": { "view": { "type": "boolean" }, "create": { "type": "boolean" }, "edit": { "type": "boolean" }, "delete": { "type": "boolean" } } },
            "settings": { "type": "object", "properties": { "view": { "type": "boolean" }, "edit": { "type": "boolean" } } }
          }
        }
      },
      "required": ["id", "name", "permissions"]
    },
    "Partner": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Partner",
      "type": "object",
      "description": "Represents a partner or administrator associated with one or more companies.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Partner entity, usually the CPF."
        },
        "name": {
          "type": "string",
          "description": "Full name of the partner."
        },
        "cpf": {
          "type": "string",
          "description": "CPF of the partner."
        },
        "qualification": {
          "type": "string",
          "description": "The partner's qualification or role in the company (e.g., Sócio-Administrador)."
        },
        "hasECPF": {
          "type": "boolean",
          "description": "Indicates if the partner has an active E-CPF."
        },
        "ecpfValidity": {
          "type": "string",
          "format": "date",
          "description": "Expiration date of the E-CPF certificate."
        },
        "ecpfUrl": {
          "type": "string",
          "format": "uri",
          "description": "URL of the E-CPF certificate file in Firebase Storage."
        },
        "govBrLogin": {
          "type": "string",
          "description": "Partner's login for the GOV.BR portal (stored encrypted)."
        },
        "govBrPassword": {
          "type": "string",
          "description": "Partner's password for the GOV.BR portal (stored encrypted)."
        },
        "associatedCompanies": {
          "type": "array",
          "description": "List of company names the partner is associated with.",
          "items": {
            "type": "string"
          }
        },
        "otherData": {
          "type": "string",
          "description": "Field for other relevant partner data."
        }
      },
      "required": [
        "id",
        "name",
        "cpf",
        "hasECPF"
      ]
    },
    "TaxObligation": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "TaxObligation",
      "type": "object",
      "description": "Represents a tax obligation for a specific company, including its history and related documents.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the TaxObligation entity."
        },
        "companyId": {
          "type": "string",
          "description": "Reference to Company. Company to which the tax obligation belongs."
        },
        "companyName": {
          "type": "string",
          "description": "Denormalized name of the company for quick display."
        },
        "nome": {
          "type": "string",
          "description": "Name of the obligation (e.g., DAS, DEFIS, SPED ECF)."
        },
        "categoria": {
          "type": "string",
          "description": "Category of the obligation.",
          "enum": ["Fiscal", "Contábil", "DP", "Societário"]
        },
        "periodicidade": {
          "type": "string",
          "description": "Frequency of the obligation.",
          "enum": ["Mensal", "Trimestral", "Anual", "Eventual"]
        },
        "periodo": {
          "type": "string",
          "description": "The competence period of the obligation (e.g., '2024-08')."
        },
        "dataVencimento": {
          "type": "string",
          "format": "date-time",
          "description": "Due date for the obligation."
        },
        "dataEntrega": {
          "type": "string",
          "format": "date-time",
          "description": "Date the obligation was completed/filed."
        },
        "status": {
          "type": "string",
          "description": "Current status of the obligation.",
          "enum": ["Pendente", "Em Andamento", "Entregue", "Atrasada"]
        },
        "responsavelId": {
          "type": "string",
          "description": "Reference to User. User responsible for this obligation."
        },
        "responsavelNome": {
          "type": "string",
          "description": "Denormalized name of the responsible user."
        },
        "createdAt": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp of when the obligation was created."
        },
        "updatedAt": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp of the last update."
        },
        "historico": {
          "type": "array",
          "description": "List of events related to the obligation (status changes, comments, etc.).",
          "items": {
            "type": "object",
            "properties": {
              "timestamp": {"type": "string", "format": "date-time"},
              "userId": {"type": "string"},
              "userName": {"type": "string"},
              "action": {"type": "string"},
              "details": {"type": "string"}
            }
          }
        },
        "comprovantes": {
          "type": "array",
          "description": "List of objects representing uploaded proof of delivery files in Firebase Storage.",
          "items": {
            "type": "object",
            "properties": {
              "fileName": { "type": "string" },
              "fileUrl": { "type": "string", "format": "uri"},
              "uploadedAt": { "type": "string", "format": "date-time" },
              "uploadedBy": { "type": "string" }
            }
          }
        }
      },
      "required": ["id", "companyId", "companyName", "nome", "categoria", "periodicidade", "periodo", "dataVencimento", "status", "createdAt", "updatedAt"]
    },
    "Document": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Document",
      "type": "object",
      "description": "Represents a document stored in the system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Document entity."
        },
        "companyId": {
          "type": "string",
          "description": "Reference to Company. Company to which the document belongs. (Relationship: Company 1:N Document)"
        },
        "name": {
          "type": "string",
          "description": "Name of the document."
        },
        "type": {
          "type": "string",
          "description": "Type of document (e.g., Contract, Certificate, Fiscal Archive)."
        },
        "uploadDate": {
          "type": "string",
          "description": "Date when the document was uploaded.",
          "format": "date-time"
        },
        "expirationDate": {
          "type": "string",
          "description": "Expiration date of the document, if applicable.",
          "format": "date-time"
        },
        "responsibleUserId": {
          "type": "string",
          "description": "Reference to User. User responsible for this document. (Relationship: User 1:N Document)"
        },
        "fileUrl": {
          "type": "string",
          "format": "uri"
        },
        "fileName": {
          "type": "string"
        }
      },
      "required": [
        "id",
        "companyId",
        "name",
        "type",
        "uploadDate",
        "fileUrl",
        "fileName"
      ]
    },
    "CorporateProcess": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "CorporateProcess",
      "type": "object",
      "description": "Represents a corporate process related to opening, altering, or closing a company.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the CorporateProcess entity."
        },
        "companyId": {
          "type": "string",
          "description": "Reference to Company. Company to which the corporate process belongs. (Relationship: Company 1:N CorporateProcess)"
        },
        "companyName": {
            "type": "string",
            "description": "Denormalized name of the company."
        },
        "processType": {
          "type": "string",
          "description": "Type of corporate process (e.g., Opening, Alteration, Closing)."
        },
        "startDate": {
          "type": "string",
          "description": "Start date of the corporate process.",
          "format": "date-time"
        },
        "protocolDate": {
          "type": "string",
          "description": "Protocol date of the corporate process.",
          "format": "date-time"
        },
        "status": {
          "type": "string",
          "description": "Current status of the corporate process (e.g., In Analysis, In Requirement, Concluded, Canceled)."
        },
        "responsibleUserId": {
          "type": "string",
          "description": "Reference to User. User responsible for this corporate process. (Relationship: User 1:N CorporateProcess)"
        }
      },
      "required": [
        "id",
        "companyId",
        "companyName",
        "processType",
        "startDate",
        "status"
      ]
    }
  },
  "auth": {
    "providers": [
      "password"
    ]
  },
  "firestore": {
    "structure": [
       {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Collection to store user profiles, including their role ID for RBAC.",
          "params": [
            {
              "name": "userId",
              "description": "The UID of the user."
            }
          ]
        }
      },
       {
        "path": "/roles/{roleId}",
        "definition": {
          "entityName": "Role",
          "schema": {
            "$ref": "#/backend/entities/Role"
          },
          "description": "Collection to store roles and their associated granular permissions.",
          "params": [
            {
              "name": "roleId",
              "description": "The unique identifier for the role."
            }
          ]
        }
      },
      {
        "path": "/partners/{partnerId}",
        "definition": {
          "entityName": "Partner",
          "schema": {
            "$ref": "#/backend/entities/Partner"
          },
          "description": "Collection to store partner and administrator information.",
          "params": [
            {
              "name": "partnerId",
              "description": "The unique identifier for the partner, typically their CPF."
            }
          ]
        }
      },
      {
        "path": "/companies/{companyId}",
        "definition": {
          "entityName": "Company",
          "schema": {
            "$ref": "#/backend/entities/Company"
          },
          "description": "Collection to store company information. Includes a 'members' map containing user roles within the company for authorization independence.",
          "params": [
            {
              "name": "companyId",
              "description": "The unique identifier for the company."
            }
          ]
        }
      },
      {
        "path": "/companies/{companyId}/taxObligations/{taxObligationId}",
        "definition": {
          "entityName": "TaxObligation",
          "schema": {
            "$ref": "#/backend/entities/TaxObligation"
          },
          "description": "Subcollection to store tax obligations for a specific company. Access control based on the 'members' map denormalized from the parent company document.",
          "params": [
            {
              "name": "companyId",
              "description": "The unique identifier for the company."
            },
            {
              "name": "taxObligationId",
              "description": "The unique identifier for the tax obligation."
            }
          ]
        }
      },
      {
        "path": "/companies/{companyId}/documents/{documentId}",
        "definition": {
          "entityName": "Document",
          "schema": {
            "$ref": "#/backend/entities/Document"
          },
          "description": "Subcollection to store documents related to a specific company. Access control based on the 'members' map denormalized from the parent company document.",
          "params": [
            {
              "name": "companyId",
              "description": "The unique identifier for the company."
            },
            {
              "name": "documentId",
              "description": "The unique identifier for the document."
            }
          ]
        }
      },
      {
        "path": "/companies/{companyId}/corporateProcesses/{corporateProcessId}",
        "definition": {
          "entityName": "CorporateProcess",
          "schema": {
            "$ref": "#/backend/entities/CorporateProcess"
          },
          "description": "Subcollection to store corporate processes for a specific company. Access control based on the 'members' map denormalized from the parent company document.",
          "params": [
            {
              "name": "companyId",
              "description": "The unique identifier for the company."
            },
            {
              "name": "corporateProcessId",
              "description": "The unique identifier for the corporate process."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to support the features of the ContaFlow ERP system, focusing on security, scalability, and maintainability. Key considerations include role-based access control, efficient data retrieval, and support for the core features like fiscal document processing, tax obligation management, corporate lifecycle management, financial data integration, and comprehensive document repository.\n\nAuthorization Independence is achieved through denormalization. For example, instead of relying on nested `get()` calls to verify a user's role within a company, the user's role (or relevant permissions) are copied into documents where authorization is required. Specifically:\n\n*   **Company Membership:** A `members` map within the `companies/{companyId}` document stores user roles for that company.  This is then copied to subcollections if needed.\n*   **User Roles:** Global roles (Admin, etc.) are managed using existence checks in dedicated collections (e.g., `/roles_admin/{userId}`).\n\nThis design supports the required QAPs (Rules are not Filters) by:\n\n*   **Structural Segregation:** Data with different access requirements are stored in separate collections.  User-specific data (like settings) resides under `/users/{userId}`, while company-specific data resides under `/companies/{companyId}`.\n*   **Membership Model:** Collaborative data (e.g., documents, tax obligations) associated with a company uses the `members` map denormalized from the company document for access control.\n\nFurthermore, the structure facilitates:\n\n*   **Efficient Queries:** By avoiding nested `get()` calls, queries are more efficient and scalable.\n*   **Simplified Security Rules:** Rules are more straightforward to write and debug because authorization logic is localized.\n*   **Atomic Operations:** Transactions and batch writes are supported because authorization checks do not depend on hierarchical data.\n\nEach entity has a dedicated collection, and relationships between entities are managed via document references. This approach ensures clarity, consistency, and ease of maintenance."
  }
}
