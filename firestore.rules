
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // Helper Functions
    // =========================================================================

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function getUserProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function isOwnerRole() {
      return getUserProfile().data.roleId == 'owner';
    }

    function isFinanceUser() {
      return exists(/databases/$(database)/documents/roles_finance/$(request.auth.uid));
    }

    function isCompanyMember(companyId) {
      return get(/databases/$(database)/documents/companies/$(companyId)).data.members[request.auth.uid] != null;
    }

    function canReadCompanyData(companyId) {
      return isOwnerRole() || isCompanyMember(companyId);
    }

    function isRequestingUserResponsible() {
      return request.resource.data.responsibleUserId == request.auth.uid;
    }

    function isExistingResponsibleUserOrAdmin(responsibleUserId) {
      return resource != null && (isOwnerRole() || responsibleUserId == request.auth.uid);
    }

    function isCompanyIdImmutable() {
      return request.resource.data.companyId == resource.data.companyId;
    }

    // =========================================================================
    // USERS
    // =========================================================================

    match /users/{userId} {
      allow get: if isOwner(userId) || isOwnerRole();
      allow list: if isOwnerRole();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwnerRole();
    }

    // =========================================================================
    // ROLES
    // =========================================================================

    match /roles/{roleId} {
      allow read, write: if isOwnerRole();
    }

    match /roles_finance/{userId} {
      allow read, write: if isOwnerRole();
    }

    // =========================================================================
    // COMPANIES
    // =========================================================================

    match /companies/{companyId} {
      allow get: if canReadCompanyData(companyId);
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isOwnerRole() || isCompanyMember(companyId);
      allow delete: if isOwnerRole();
    }

    // =========================================================================
    // PARTNERS
    // =========================================================================

    match /partners/{partnerId} {
      allow read, write: if isSignedIn();
    }

    // =========================================================================
    // FINANCE (invoices)
    // =========================================================================

    match /invoices/{invoiceId} {
      allow list, get, create, update, delete: if isFinanceUser() || isOwnerRole();
    }

    // =========================================================================
    // TAX OBLIGATIONS (Root Collection)
    // =========================================================================
    
    match /taxObligations/{taxObligationId} {
       allow read, list: if isSignedIn(); // Simplified for listing, detailed check on client
       allow create, update, delete: if isSignedIn() && canReadCompanyData(request.resource.data.companyId);
    }

    // =========================================================================
    // CORPORATE PROCESSES (Root Collection)
    // =========================================================================

    match /corporateProcesses/{processId} {
      allow read, list: if isSignedIn(); // Simplified for listing, detailed check on client
      allow create: if canReadCompanyData(request.resource.data.companyId) && isRequestingUserResponsible();
      allow update, delete: if canReadCompanyData(resource.data.companyId);
    }
    
    // =========================================================================
    // DOCUMENTS
    // =========================================================================

    match /companies/{companyId}/documents/{documentId} {
      allow read, list: if canReadCompanyData(companyId);
      allow create: if canReadCompanyData(companyId) && isRequestingUserResponsible();
      allow update, delete: if isExistingResponsibleUserOrAdmin(resource.data.responsibleUserId) && isCompanyIdImmutable();
    }

    // =========================================================================
    // ACTIVITY LOG
    // =========================================================================

    match /activities/{activityId} {
      allow read, list, create: if isSignedIn();
      allow update, delete: if isOwnerRole();
    }
  }
}
