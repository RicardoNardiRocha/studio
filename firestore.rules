rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // Helper Functions
    // =========================================================================
    function isSignedIn() {
      return request.auth != null;
    }

    // Get the user's profile from the /users collection
    function getUserProfile(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }
    
    function canRead(module) {
      return getUserProfile(request.auth.uid).permissions[module].read == true;
    }
    
    function canCreate(module) {
      return getUserProfile(request.auth.uid).permissions[module].create == true;
    }
    
    function canUpdate(module) {
      return getUserProfile(request.auth.uid).permissions[module].update == true;
    }

    function canDelete(module) {
      return getUserProfile(request.auth.uid).permissions[module].delete == true;
    }

    // =========================================================================
    // Collection Rules
    // =========================================================================

    // --- User Profiles ---
    match /users/{userId} {
      // Um usuário pode sempre ler e atualizar seu próprio perfil básico (nome, foto).
      allow read: if isSignedIn();
      allow update: if request.auth.uid == userId;
      
      // Apenas usuários com permissão de 'update' no módulo 'usuarios' podem alterar
      // o perfil (incluindo permissões) de outros usuários.
      allow update: if canUpdate('usuarios');
      
      // Apenas usuários com permissão de 'delete' podem excluir outros usuários.
      allow delete: if canDelete('usuarios');
      
      // Apenas usuários com permissão de 'create' podem criar novos usuários (embora a criação seja no Auth).
      allow create: if canCreate('usuarios');
    }

    // --- Companies ---
    match /companies/{companyId} {
      allow list, get: if canRead('empresas');
      allow create: if canCreate('empresas');
      allow update: if canUpdate('empresas');
      allow delete: if canDelete('empresas');
    }

    // --- Partners ---
    match /partners/{partnerId} {
      allow read: if canRead('societario');
      allow write: if canCreate('societario') || canUpdate('societario');
    }

    // --- Invoices ---
    match /invoices/{invoiceId} {
      allow read: if canRead('financeiro');
      allow write: if canCreate('financeiro') || canUpdate('financeiro');
    }

    // --- Tax Obligations ---
    match /taxObligations/{taxObligationId} {
      allow read: if canRead('obrigacoes');
      allow create: if canCreate('obrigacoes');
      allow update: if canUpdate('obrigacoes');
      allow delete: if canDelete('obrigacoes');

      match /{subcollection}/{subDocId} {
        allow read, write: if canRead('obrigacoes');
      }
    }
    
    // --- Corporate Processes ---
    match /corporateProcesses/{processId} {
      allow read: if canRead('processos');
      allow create: if canCreate('processos');
      allow update: if canUpdate('processos');
      allow delete: if canDelete('processos');

      match /{subcollection}/{subDocId} {
        allow read, write: if canRead('processos');
      }
    }

    // --- Documents within a Company ---
    match /companies/{companyId}/documents/{documentId} {
       allow read: if canRead('documentos');
       allow write: if canCreate('documentos') || canUpdate('documentos') || canDelete('documentos');
    }

    // --- Activity Log ---
    match /activities/{activityId} {
      allow read, create: if isSignedIn();
      allow update, delete: if false; // Immutable log
    }
  }
}
