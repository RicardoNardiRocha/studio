
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // Funções permitidas (apenas expressões)
    // =========================================================================

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    function isCompanyMember(companyId) {
      return get(/databases/$(database)/documents/companies/$(companyId)).data.members[request.auth.uid] != null;
    }

    function canReadCompanyData(companyId) {
      return isAdmin() || isCompanyMember(companyId);
    }

    function isRequestingUserResponsible() {
      return request.resource.data.responsibleUserId == request.auth.uid;
    }

    function isExistingResponsibleUserOrAdmin() {
      return resource != null && (isAdmin() || isOwner(resource.data.responsibleUserId));
    }

    function isDocIdImmutable() {
      return request.resource.data.id == resource.data.id;
    }

    function hasConsistentCompanyId(companyId) {
      return request.resource.data.companyId == companyId;
    }
    
    function isCompanyIdImmutable() {
      return request.resource.data.companyId == resource.data.companyId;
    }

    // =========================================================================
    // RULES
    // =========================================================================

    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && isDocIdImmutable();
      allow delete: if isOwner(userId);
    }

    match /roles_admin/{userId} {
      allow read, list: if isAdmin();
      allow create, update, delete: if false; // Somente manual pelo console!
    }

    match /roles_finance/{userId} {
      allow read, write: if isAdmin();
    }

    match /companies/{companyId} {
      allow get: if canReadCompanyData(companyId);
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if (isAdmin() || isCompanyMember(companyId));
      allow delete: if (isAdmin() || isCompanyMember(companyId));
    }

    match /partners/{partnerId} {
      allow read, write: if isSignedIn();
    }

    match /invoices/{invoiceId} {
      allow list, get, create, update, delete:
        if isAdmin() || exists(/databases/$(database)/documents/roles_finance/$(request.auth.uid));
    }

    match /taxObligations/{taxObligationId} {
      allow read, list, create, update, delete:
        if isSignedIn() && canReadCompanyData(request.resource.data.companyId);
      
      // Allow access to subcollections
      match /attachments/{attachmentId} {
         allow read, write, delete: if canReadCompanyData(get(/databases/$(database)/documents/taxObligations/$(taxObligationId)).data.companyId);
      }
      match /history/{historyId} {
         allow read, write: if canReadCompanyData(get(/databases/$(database)/documents/taxObligations/$(taxObligationId)).data.companyId);
      }
    }

    match /corporateProcesses/{processId} {
      allow read, list, create, update, delete:
        if isSignedIn() && canReadCompanyData(request.resource.data.companyId);
    }

    match /companies/{companyId}/documents/{documentId} {
      allow get, list: if canReadCompanyData(companyId);
      allow create: if canReadCompanyData(companyId) && isRequestingUserResponsible();
      allow update: if isExistingResponsibleUserOrAdmin() && isCompanyIdImmutable();
      allow delete: if isExistingResponsibleUserOrAdmin();
    }

    match /activities/{activityId} {
      allow read, list, create: if isSignedIn();
      allow update, delete: if isAdmin();
    }
  }
}
