
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // Helper Functions
    // =========================================================================

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user's UID matches the given userId.
     * Used for document ownership checks.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * Retrieves the user's profile document.
     */
    function getUserProfile() {
        return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    /**
     * Retrieves the role document associated with the current user.
     */
    function getUserRole() {
        let userProfile = getUserProfile();
        if (userProfile.data.roleId != null) {
            return get(/databases/$(database)/documents/roles/$(userProfile.data.roleId));
        }
        return null;
    }

    /**
     * Checks if the user has the 'owner' role.
     */
    function isOwnerRole() {
      let userProfile = getUserProfile();
      return userProfile.data.roleId == 'owner';
    }

    /**
     * Checks if the user has finance module access by checking for a document
     * in the `roles_finance` collection.
     */
    function isFinanceUser() {
      return exists(/databases/$(database)/documents/roles_finance/$(request.auth.uid));
    }

    /**
     * Checks if the user has a specific granular permission.
     * Example: hasPermission('companies', 'create')
     */
    function hasPermission(resource, operation) {
        let userRole = getUserRole();
        return userRole != null && userRole.data.permissions[resource][operation] == true;
    }

    /**
     * Checks if a user is a member of a specific company by verifying their UID
     * exists as a key in the company's 'members' map.
     */
    function isCompanyMember(companyId) {
      return get(/databases/$(database)/documents/companies/$(companyId)).data.members[request.auth.uid] != null;
    }

    /**
     * Combines owner role and company member checks for granting read access.
     */
    function canReadCompanyData(companyId) {
      return isOwnerRole() || isCompanyMember(companyId);
    }
    
    /**
     * On update/delete, checks if the document exists and if the requesting user
     * is either the original creator (responsibleUserId) or an admin.
     */
    function isExistingResponsibleUserOrAdmin(responsibleUserId) {
      return resource != null && (isOwnerRole() || isOwner(responsibleUserId));
    }

    // =========================================================================
    // Data Validation Helper Functions (Prototyping Mode)
    // =========================================================================
    function isConsistentDocId(docId) {
      return request.resource.data.id == docId;
    }

    function isDocIdImmutable() {
      return request.resource.data.id == resource.data.id;
    }

    function hasConsistentCompanyId(companyId) {
      return request.resource.data.companyId == companyId;
    }

    function isCompanyIdImmutable() {
      return request.resource.data.companyId == resource.data.companyId;
    }

    function isRequestingUserResponsible() {
      return request.resource.data.responsibleUserId == request.auth.uid;
    }

    function isResponsibleUserImmutableOrAdmin() {
      return isOwnerRole() || request.resource.data.responsavelId == resource.data.responsavelId;
    }

    // =========================================================================
    // Rule Definitions
    // =========================================================================

    /**
     * @description User profile data. A user can manage their own profile. Owners can read any profile.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isOwnerRole();
      allow list: if isOwnerRole();
      allow create: if isOwner(userId); // Allow user to create their own profile doc
      allow update: if isOwner(userId);
      allow delete: if isOwnerRole();
    }
    
    /**
     * @description Roles and permissions definitions. Only owners can manage roles.
     */
    match /roles/{roleId} {
        allow read, write: if isOwnerRole();
    }
    
    /**
     * @description Finance role assignments. Only owners can manage who has finance access.
     */
    match /roles_finance/{userId} {
        allow read, write: if isOwnerRole();
    }

    /**
     * @description Company records. Access is controlled by a 'members' map or owner role.
     */
    match /companies/{companyId} {
      allow get: if canReadCompanyData(companyId);
      allow list: if isSignedIn();
      allow create: if isSignedIn(); // Simplified for now
      allow update: if isOwnerRole() || isCompanyMember(companyId);
      allow delete: if isOwnerRole();
    }
    
    /**
     * @description Partner records. Any authenticated user can manage for now.
     */
    match /partners/{partnerId} {
        allow read, write: if isSignedIn();
    }
    
    /**
     * @description Finance module data. Access is restricted to users in the `roles_finance` collection.
     */
    match /finance/{docId} {
      allow read, write: if isFinanceUser();
    }

    /**
     * @description Tax obligations for a company. Inherits access from the parent company.
     */
    match /companies/{companyId}/taxObligations/{taxObligationId} {
      allow get, list, create, update, delete: if canReadCompanyData(companyId);
    }

    /**
     * @description Documents for a company. Inherits access from the parent company.
     */
    match /companies/{companyId}/documents/{documentId} {
      allow get: if canReadCompanyData(companyId);
      allow list: if canReadCompanyData(companyId);
      allow create: if canReadCompanyData(companyId) && isRequestingUserResponsible();
      allow update: if isExistingResponsibleUserOrAdmin(resource.data.responsibleUserId) && isCompanyIdImmutable();
      allow delete: if isExistingResponsibleUserOrAdmin(resource.data.responsibleUserId);
    }

    /**
     * @description Corporate processes for a company. Inherits access from the parent company.
     */
    match /companies/{companyId}/corporateProcesses/{corporateProcessId} {
      allow get: if canReadCompanyData(companyId);
      allow list: if canReadCompanyData(companyId);
      allow create: if canReadCompanyData(companyId) && isRequestingUserResponsible();
      allow update: if isExistingResponsibleUserOrAdmin(resource.data.responsibleUserId) && isCompanyIdImmutable();
      allow delete: if isExistingResponsibleUserOrAdmin(resource.data.responsibleUserId);
    }
  }
}
